<div *ngIf="isOverview">
    <app-header></app-header>
</div>

<div *ngIf="{
    project: project$ | async,
    walletMW: projectWalletMW$ | async,
    news: news$ | async,
    user: user$ | async
} as states" class="wow fadeIn container" style="background: #fdfdfd">
    <div class="app-page-title-back" (click)="backToPreviousScreen()">
        <i class="fas fa-long-arrow-alt-left mr-3"></i>
        {{ !isPortfolioView ? "OFFER DETAILS" : "PORTFOLIO DETAILS" }}
    </div>

    <div *ngIf="states.project !== null else overlaySpinner">
        <!-- Closed project popup -->
        <div *ngIf="!states.project.active" class="col-lg-12 mb-3">
            <div class="alert alert-danger">
                The project is not open for funding. If you wish to invest, please check project at a
                later date.
            </div>
        </div>

        <div class="offer-left col-lg-7">
            <div class="wow fadeIn">
                <img class="left__img w-100" src="{{states.project.main_image}}"
                     onerror="this.onerror=null; this.src='../../../../assets/noimage.png'">
            </div>
        </div>

        <div class="offer-right col-lg-5">
            <div class="right__container">

                <div class="right__text">
                    <div>
                        <h1 class="app-basic-title">{{ states.project.name }}</h1>
                    </div>

                    <div class="right__location">
                        <p (click)="openModal(states.project)">
                            <i class="location__icon fas fa-map-marker-alt"></i>
                            Show location
                        </p>
                        {{ states.project.location_text }}
                    </div>

                    <div class="right__progress">
                        <ng-container *ngIf="!!states.walletMW else smallSpinner">
                            <span>{{ states.walletMW.totalFundsRaised | currencyDefault }} </span>raised of
                            {{ states.walletMW.investmentCap | currencyDefault }} goal
                            <div class="progress__element">
                                <div [style.width.%]="(states.walletMW?.totalFundsRaised / states.walletMW?.investmentCap) * 100"
                                     class="progress__bar"
                                     role="progressbar">
                                </div>
                            </div>
                        </ng-container>
                    </div>

                    <div class="right__info">
                        <ng-container *ngIf="states.project.roi.from != 0">
                            <div class="right__return-rate">
                                <span>{{ states.project.roi.from }}% - {{ states.project.roi.to }}%</span>
                                Expected yearly return
                            </div>

                            <div class="dropdown-divider"></div>
                        </ng-container>

                        <div class="right__min-invest">
                            <span>{{ states.project.min_per_user | currencyDefault }}</span>Min Investment
                        </div>
                        <div class="dropdown-divider"></div>

                        <div class="right__max-invest">
                            <span>{{ states.project.max_per_user | currencyDefault }}</span>Max Investment
                        </div>
                        <div class="dropdown-divider"></div>

                        <div class="right__fund-period">
                            <span>Funding period</span>
                            {{ states.project.start_date | date:'mediumDate' }}
                            - {{ states.project.end_date | date:'mediumDate' }}
                        </div>
                    </div>

                    <div class="right__invest">
                        <div *ngIf="!isPortfolioView">
                            <ng-container *ngTemplateOutlet="investButtons"></ng-container>
                        </div>
                        <div *ngIf="isPortfolioView && !disableInvestButton(states.project, states.walletMW)"
                             class="portfolio__invest">
                            <ng-container *ngTemplateOutlet="investButtons"></ng-container>

                            <ng-container *ngIf="(isProjectCancelable$ | async) as isCancelable">
                                <app-action-button text="Cancel my investment"
                                                   loadingText="Cancelling investments..."
                                                   faIcon="fa-times-circle"
                                                   buttonClass="btn btn-danger font-weight-bold mb-4"
                                                   [disabled]="!isCancelable"
                                                   [onClick]="cancelInvestment(states.project.uuid).bind(this)">
                                </app-action-button>
                            </ng-container>
                        </div>
                        <ng-template #investButtons>
                            <button *ngIf="isOverview" class="btn btn-primary w-100"
                                    id="invest-button"
                                    [routerLink]="'/sign_up' | coopPath">
                                <i class="mr-2 fas fa-chart-pie"></i>
                                Sign Up & Invest
                            </button>

                            <div *ngIf="!isOverview && !!states.user">
                                <button *ngIf="states.user.verified"
                                        [disabled]="disableInvestButton(states.project, states.walletMW)"
                                        class="btn btn-primary w-100"
                                        (click)="goToInvest(states.project.uuid)">
                                    <i class="mr-2 fas fa-chart-pie"></i>
                                    {{ isPortfolioView ? 'Increase investment' : 'Invest' }}
                                </button>
                                <button *ngIf="!states.user.verified" [disabled]="!states.project.active"
                                        class="btn btn-primary w-100"
                                        [routerLink]="'/dash/settings/user' | coopPath">
                                    <i class="mr-2 fas fa-chart-pie"></i>
                                    Verify Profile & Invest
                                </button>
                            </div>
                        </ng-template>
                    </div>
                </div>
            </div>

            <div class="offer-right-socials col-lg-5">
                <div class="socials__content">
                    <p>Share</p>
                    <div class="socials__link">
                        <a href="https://twitter.com/intent/tweet?url={{ getProjectURL(states.project.uuid) }}"
                           target="_blank">
                            <i class="socials__icon fab fa-twitter"></i>
                        </a>
                    </div>
                    <div class="socials__link">
                        <a href="https://www.facebook.com/sharer/sharer.php?u={{ getProjectURL(states.project.uuid) }}"
                           target="_blank">
                            <i class="socials__icon fab fa-facebook-f"></i>
                        </a>
                    </div>
                    <div class="socials__link" #copyToClipboard="bs-tooltip"
                         (click)="copyProjectDetailsUrl(copyToClipboard, states.project.uuid)"
                         tooltip="Copied to clipboard."
                         triggers="">
                        <i class="fas fa-link"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="offer-left col-lg-7">
            <div class="left__desc">
                <div *ngIf="!isPortfolioView else tabbedView">
                    <ng-container *ngTemplateOutlet="projectDetails"></ng-container>
                </div>
            </div>
        </div>
    </div>

    <ng-template #projectDetails>
        <div class="left__inner">
            <div [innerHTML]="states.project.description"></div>
            <div class="left__docs">
                <div *ngFor="let doc of states.project.documents">
                    <div class="docs__links">
                        <a href="{{ doc.link }}">
                            <i class="fas fa-file-download"></i>
                            <span>{{ doc.name }}</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </ng-template>

    <ng-template #tabbedView>
        <tabset>
            <tab heading="Transactions">
                <div class="investments__container">
                    <div class="investment__total">
                        <div class="total__title">Total Invested</div>
                        <div class="total__amount">
                            <ng-container *ngIf="(investmentTotal$ | async) as investmentTotal else smallSpinner">
                                {{ investmentTotal | currencyDefault }}
                            </ng-container>
                        </div>
                    </div>

                    <ng-container *ngIf="(transactions$ | async) as transactions">
                        <div class="investments__history flex__center-space"
                             *ngFor="let transaction of transactions.transactions">
                            <div class="history__left">
                                <div class="history__amount">
                                    {{ transaction.amount | currencyDefault }}
                                </div>
                                <div class="history__date">
                                    {{ transaction.date | date:'medium' }}
                                </div>
                            </div>
                            <div class="history__right">
                                <!-- TODO: Implement download transaction report functionality
                                <div class="history__icon">
                                    <i class="fas fa-file-chart-line"></i>
                                </div> -->
                            </div>
                        </div>
                    </ng-container>
                </div>

            </tab>
            <tab heading="Details">
                <ng-container *ngTemplateOutlet="projectDetails"></ng-container>
            </tab>
        </tabset>
    </ng-template>
</div>

<ng-template #overlaySpinner>
    <app-spinner type="overlay"></app-spinner>
</ng-template>

<ng-template #smallSpinner>
    <span>
        <app-spinner type="inline"></app-spinner>
    </span>
</ng-template>
